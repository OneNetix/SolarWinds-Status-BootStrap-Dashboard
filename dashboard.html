<!------------------------------------------------------------------------------
    This was designed and build by Liam at OneNetix LTD for use as a custom HTML 
    Resource in Solarwinds Orion tested at the time on NPM Version 12.5 HF2
    Head over to our website OneNetix.com for more code and be sure to show us 
    some love online through social media.

    In order to use this make sure you have a node custom property defined
    for Applications and Team. Make sure team and applications is filled in

    Happy coding! 

    01001111 01101110 01100101 01101110 01100101 01110100 01101001 01111000 
    01110011 01100001 01111001 01110011  01110111 01100001 01101011 01100101 
    01110101 01110000  01001110 01100101 01101111 
//----------------------------------------------------------------------------->


<!DOCTYPE html>
<html lang="en">
<head>
  <title>Bootstrap Example</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <style>
  .pointer {cursor: pointer;}
  </style>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

 

  <script>
   setInterval(function(){
                $('blink').each(function() {
                $(this).toggle();
            });
        }, 1000);

        //Main table function
        function getApplications() {

            //Query the nodes custom properties table for applications where team = X change X to be based on what team specific results you want to see
            var getAppQuery = JSON.stringify({query:"SELECT DISTINCT Applications FROM Orion.NodesCustomProperties WHERE Team = 'X' AND Applications IS NOT NULL"} ); 
                    $.ajax({
                    type: 'POST', 
                    url: '/Orion/Services/Information.asmx/Query', 
                    data: getAppQuery, 
                    contentType: "application/json; charset=utf-8", 
                    dataType: "json",
                    async: false, 
                    success: function (appResponse) {
                    var appResult = ''
                    var headerResult = ''
                    headerName = [];
                    appCard = [];
        
                    //Loop through results, for each result query the application name to get the app status
                    for (i = 0; i < appResponse.d.Rows.length; i++) {
                        var appStatus = JSON.stringify({query:"SELECT StatusName, case when Color = 'yellow' then 'text-warning' when Color = 'red' then 'text-danger' when Color = 'darkblue' then 'text-primary' when Color = 'lightgreen' then 'text-success' when Color = 'darkred' then 'text-danger' else Color end as Color, case when count(n.status) is null then 0 else count(n.status) end as num, case when statusname = 'down' then 100 when statusname = 'critical' then 50 when statusname = 'warning' then 45 when statusname = 'unmanaged' then 40 when statusname = 'up' then 39 end as fsize FROM Orion.StatusInfo s left join Orion.Nodes n on s.statusid=n.status left join Orion.NodesCustomProperties as cp on cp.NodeID = n.NodeID where cp.Applications = '"+appResponse.d.Rows[i]+"' AND s.statusid in (1,2,3,9,14) group by StatusName, Color order by fsize desc, num desc"} ); 
                            $.ajax({
                            type: 'POST', 
                            url: '/Orion/Services/Information.asmx/Query', 
                            data: appStatus, 
                            contentType: "application/json; charset=utf-8", 
                            dataType: "json",
                            async: false, 
                            success: function (appStatusResponse) {
                            var appStatusHeaderCol = ''
                            var appStatusName = ''
                            var i;
                            headerStatus = [];
                            bodyStatus = [];

                                //Loop though the application results and build objects for the body of the card resource this will be the qty of each status such as 12 up and 1 down
                                for (i = 0; i < appStatusResponse.d.Rows.length; i++) {          
                                    bodyStatus.push('<h3 class="'+appStatusResponse.d.Rows[i][1]+' text-center ">'+appStatusResponse.d.Rows[i][0]+' - '+appStatusResponse.d.Rows[i][2]+'</h3>');
                                }

                                    //Define header colours and push to an object
                                    if(appStatusResponse.d.Rows[0][1] == "text-warning"){
                                        appStatusHeaderCol = appStatusHeaderCol + String('bg-warning');
                                        headerStatus.push(appStatusHeaderCol);
                                    }else if(appStatusResponse.d.Rows[0][1] == "text-danger"){
                                        appStatusHeaderCol = appStatusHeaderCol + String('bg-danger');
                                        headerStatus.push(appStatusHeaderCol);
                                    }else{
                                        appStatusHeaderCol = appStatusHeaderCol + String('bg-success');
                                        headerStatus.push(appStatusHeaderCol);
                                    }

                                var outputHeadCol = appStatusHeaderCol
                            
                            }
                            
                        })
                        
                        //Merge the objects for the status colour and application status quantity and build into a BS card
                        //Take note of the onclick here, this enables you to click the card and then get the list of nodes that resides under that status
                        appCard.push("<div class='col-sm-4'><div  class='card pointer ' id='"+appResponse.d.Rows[i][0]+"' onclick='getvalue(this.id)'><div class='card-header text-white "+ headerStatus +"' ><h3 class='text-center'>"+ appResponse.d.Rows[i][0] + "</h3></div><div class='card-body'>"+ bodyStatus +"</div></div></div>"); 
                       
                    }   
                        //Loop though the card objects
                        text = "";
                        for(i = 0; i < appCard.length; i++){
                            text += appCard[i];
                        }
                        
                        //Push to results to the card ID in the HTML body
                        document.getElementById("statusCard").innerHTML = text;
                        var outputApp = appResult
                    }
            })

            
        }

    </script>
    <script>
        //This function is called when you click a card, this will display a new card at the bottom of the page to show nodes that reside under the clicked status
        function getvalue(clicked_id)
            {
                var devices = JSON.stringify({query:"SELECT '/Orion/images/StatusIcons/small-' + ToString(N.StatusIcon) AS [Status],'/NetPerfMon/Images/Vendors/' + ToString(N.VendorIcon) AS [Vendor],n.Caption AS [Node], n.IP_Address,'/Orion/NetPerfMon/NodeDetails.aspx?NetObject=N%3a' + ToString(N.NodeID) AS [nodeLink] FROM Orion.Nodes as n  LEFT JOIN Orion.NodesCustomProperties as cp on cp.nodeid = n.nodeid WHERE cp.Applications = '"+clicked_id+"'"} ); 
                $.ajax({
                    type: 'POST', 
                    url: '/Orion/Services/Information.asmx/Query', 
                    data: devices, 
                    contentType: "application/json; charset=utf-8", 
                    dataType: "json",
                    async: false, 
                    success: function (response) {
                    var results = ''   
                    var subHeader = ''    
                        for (i = 0; i < response.d.Rows.length; i++) {
                            results = results + String('<div><a href="'+response.d.Rows[i][4]+'" target="_blank"><p><img src=' + response.d.Rows[i][0] +'></img> <img src=' + response.d.Rows[i][1] +'></img> ' + response.d.Rows[i][2] + ' - ' +response.d.Rows[i][3] +'</p></a></div>');
                        } 
                        subHeader = subHeader + String('<div class="card"><div class="card-header bg-secondary text-white"><h3 class="text-center">'+clicked_id+'</h3></div><div class="card-body">'+results+'</div> </div>');
                        document.getElementById("nodeDetails").innerHTML = subHeader;
                        var devicesOutput = results
                    }
                })  
            }
            
    </script>
</head>

<!--Load main table funtion-->
<body onload="getApplications()">

<!-- BootStrap main table-->
<div class="container">
    <div class="row">
        <div id="statusCard"></div>
    </div>
</div>

<!-- BootStrap table when clicking a BS Card-->
<div class="col-sm-12">
    <div id="nodeDetails"></div>
</div>
   
</body>
</html>
